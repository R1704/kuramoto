<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kuramoto - 2D/3D</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #0a0a0a;
            font-family: 'Monaco', 'Courier New', 'Consolas', monospace;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }
        #app {
            display: grid;
            grid-template-columns: 1fr auto 360px;
            grid-template-areas: "canvas visualizer controls";
            height: 100vh;
            gap: 0;
        }
        #canvas-container {
            grid-area: canvas;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        #control-panel {
            grid-area: controls;
        }
        #visualizer-panel {
            grid-area: visualizer;
        }
        canvas { 
            border: 1px solid #333;
            cursor: grab;
            display: block;
        }
        canvas:active { cursor: grabbing; }
        
        #kernel-canvas-1d,
        #kernel-canvas-2d {
            width: 100%;
            max-width: 280px;
            cursor: default;
            image-rendering: pixelated;
        }
        
        #control-panel {
            background: #1a1a1a;
            border-left: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 60px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }
        
        #visualizer-panel {
            width: 300px;
            background: #151515;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: width 0.2s ease, padding 0.2s ease;
        }
        
        /* Collapsed state when hidden */
        #visualizer-panel[style*="display: none"] {
            width: 0 !important;
            padding: 0 !important;
            border: none !important;
            overflow: hidden !important;
        }
        
        .viz-section {
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #2a2a2a;
        }
        
        .viz-title {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        h1 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }
        
        .subtitle {
            font-size: 11px;
            color: #888;
            margin-bottom: 16px;
        }
        
        .section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: color 0.2s;
        }
        
        .section-title:hover {
            color: #ddd;
        }
        
        .section-title::after {
            content: '‚ñº';
            font-size: 10px;
            transition: transform 0.2s;
        }
        
        .section-title.collapsed::after {
            transform: rotate(-90deg);
        }
        
        .section-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        
        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-label {
            font-size: 13px;
            color: #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .control-value {
            font-family: 'Monaco', 'Courier New', monospace;
            color: #4a9eff;
            font-size: 12px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            transition: opacity 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #4a9eff;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #6bb3ff;
        }
        
        input[type="range"]:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        input[type="range"]:disabled::-webkit-slider-thumb {
            cursor: not-allowed;
            background: #666;
        }
        
        input[type="number"] {
            width: 80px;
            padding: 4px 8px;
            background: #0d0d0d;
            border: 1px solid #333;
            color: #eee;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        
        select {
            padding: 6px 10px;
            background: #0d0d0d;
            border: 1px solid #333;
            color: #eee;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
        }
        
        button {
            padding: 8px 14px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #eee;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        button:hover {
            background: #333;
            border-color: #555;
        }
        
        button:active {
            background: #1a1a1a;
        }
        
        button.active {
            background: #4a9eff;
            border-color: #4a9eff;
            color: #000;
        }
        
        button.active:hover {
            background: #6bb3ff;
            border-color: #6bb3ff;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .preset-btn {
            font-size: 11px;
            padding: 6px 8px;
        }
        
        .stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: #0d0d0d;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #333;
            font-size: 11px;
        }
        
        .stats > div {
            display: flex;
            justify-content: space-between;
        }
        
        .stats .value {
            color: #4a9eff;
            font-weight: 600;
        }
        
        #global-indicator {
            display: none;
            background: #ff9900;
            color: #000;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .control-group.disabled {
            opacity: 0.5;
        }
        
        .control-group.disabled .control-label {
            color: #666;
        }
        
        .keyboard-hint {
            background: #0d0d0d;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #333;
            font-size: 10px;
            line-height: 1.6;
            color: #aaa;
        }
        
        .keyboard-hint strong {
            color: #ccc;
            font-size: 11px;
        }
        
        kbd {
            background: #222;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 10px;
            color: #4a9eff;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="canvas-container">
            <canvas id="canvas" width="1000" height="800"></canvas>
        </div>
        
        <div id="control-panel">
            <div>
                <h1>Kuramoto</h1>
                <div class="subtitle">2D/3D WebGPU Visualization</div>
                <div class="stats" id="stats">
                    <div><span>FPS</span><span class="value" id="fps">--</span></div>
                    <div><span>Oscillators</span><span class="value" id="count">--</span></div>
                    <div><span>Grid</span><span class="value" id="grid">--</span></div>
                </div>
            </div>
            
            <!-- VIEW & GRID CONTROLS -->
            <div class="section">
                <div class="section-title">View & Grid Settings</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>View Mode</span>
                    </div>
                    <div class="button-group">
                        <button id="view-3d-btn" class="active">3D Terrain</button>
                        <button id="view-2d-btn">2D Flat</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Grid Size</span>
                        <span class="control-value" id="grid-size-value">256</span>
                    </div>
                    <input type="number" id="grid-size-input" min="64" max="1024" step="64" value="256">
                    <button id="apply-grid-btn">Apply Grid Size</button>
                    <div style="font-size: 10px; color: #888;">üìù Valid: 64, 128, 192, ..., 1024 (multiples of 64)</div>
                </div>
            </div>
            
            <!-- 1. PATTERN PRESETS -->
            <div class="section">
                <div class="section-title">Pattern Presets</div>
                <div style="font-size: 10px; color: #666; margin-bottom: 4px;">Basic Patterns</div>
                <div class="button-group">
                    <button class="preset-btn" data-preset="sync">üîÑ Global Sync</button>
                    <button class="preset-btn" data-preset="grains">üåæ Grains</button>
                    <button class="preset-btn" data-preset="clusters">üë• Clusters</button>
                    <button class="preset-btn" data-preset="checkerboard">üèÅ Checkerboard</button>
                </div>
                
                <div style="font-size: 10px; color: #666; margin-top: 12px; margin-bottom: 4px;">Wave Patterns</div>
                <div class="button-group">
                    <button class="preset-btn" data-preset="plane_wave">üåä Plane Wave</button>
                    <button class="preset-btn" data-preset="target_waves">üéØ Target Waves</button>
                    <button class="preset-btn" data-preset="target_waves_inward">‚¨ÖÔ∏è Inward Waves</button>
                </div>
                
                <div style="font-size: 10px; color: #666; margin-top: 12px; margin-bottom: 4px;">Spiral Patterns</div>
                <div class="button-group">
                    <button class="preset-btn" data-preset="single_spiral">üåÄ Single Spiral</button>
                    <button class="preset-btn" data-preset="spiral_simple">üåÄ Simple Spiral</button>
                    <button class="preset-btn" data-preset="spiral_pair">üåÄüåÄ Spiral Pair</button>
                    <button class="preset-btn" data-preset="spiral_pair_interference">üåäüåÄ Interference</button>
                    <button class="preset-btn" data-preset="delay_spirals">‚è±Ô∏è Delay Spirals</button>
                </div>
                
                <div style="font-size: 10px; color: #666; margin-top: 12px; margin-bottom: 4px;">Complex Patterns</div>
                <div class="button-group">
                    <button class="preset-btn" data-preset="chimera">üë• Chimera</button>
                    <button class="preset-btn" data-preset="breathing">ü´Å Breathing</button>
                    <button class="preset-btn" data-preset="turbulence">üí® Turbulence</button>
                    <button class="preset-btn" data-preset="turbulence_simple">üå™Ô∏è Turbulence 2</button>
                </div>
            </div>
            
            <!-- 2. INITIAL CONDITIONS -->
            <div class="section">
                <div class="section-title">Initial Conditions</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Phase Pattern (Œ∏)</span>
                    </div>
                    <select id="theta-pattern-select">
                        <option value="random">Random</option>
                        <option value="gradient">Gradient</option>
                        <option value="spiral">Spiral</option>
                        <option value="checkerboard">Checkerboard</option>
                        <option value="target">Target</option>
                        <option value="image">From Image</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Frequency Pattern (œâ)</span>
                    </div>
                    <select id="omega-pattern-select">
                        <option value="random">Random (Gaussian)</option>
                        <option value="uniform">Uniform</option>
                        <option value="gradient">Gradient</option>
                        <option value="checkerboard">Checkerboard</option>
                        <option value="image">Image/Video Input</option>
                    </select>
                </div>
                
                <div class="control-group" id="external-input-controls" style="display: none;">
                    <div style="margin-bottom: 8px;">
                        <label for="image-upload" class="button-group" style="cursor: pointer; display: inline-block; padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
                            <span>üìÅ Upload Image</span>
                            <input type="file" id="image-upload" accept="image/*" style="display: none;">
                        </label>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <button id="webcam-btn">üì∑ Use Webcam</button>
                    </div>
                    <video id="video-input" style="display: none;"></video>
                    <canvas id="image-preview" width="128" height="128" style="width: 128px; height: 128px; border: 1px solid #333; border-radius: 4px; display: none;"></canvas>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>œâ Amplitude</span>
                        <span class="control-value" id="omega-amplitude-value">0.40</span>
                    </div>
                    <input type="range" id="omega-amplitude-slider" min="0" max="1" step="0.01" value="0.4">
                </div>
                
                <div class="button-group">
                    <button id="reset-btn">Reset</button>
                    <button id="randomize-btn">Randomize Œ∏</button>
                </div>
            </div>
            
            <!-- 3. COUPLING RULE -->
            <div class="section">
                <div class="section-title">Coupling Rule</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Coupling Mode</span>
                    </div>
                    <select id="rule-select">
                        <option value="0">0: Classic Kuramoto</option>
                        <option value="1">1: Coherence-Gated</option>
                        <option value="2">2: Curvature-Aware</option>
                        <option value="3">3: Harmonics (2nd+3rd)</option>
                        <option value="4">4: Mexican-Hat Kernel</option>
                        <option value="5">5: Delay-Coupled</option>
                    </select>
                    <div id="rule-desc" style="font-size: 10px; color: #888; line-height: 1.4;">
                        Classic: dŒ∏/dt = œâ + K¬∑sin(Œ∏‚±º - Œ∏·µ¢)
                    </div>
                </div>
                
                <div id="global-indicator">üåç GLOBAL COUPLING ACTIVE</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Coupling Strength (K‚ÇÄ)</span>
                        <span class="control-value" id="k0-value">1.00</span>
                    </div>
                    <input type="range" id="k0-slider" min="0" max="3" step="0.1" value="1.0">
                </div>
                
                <div class="control-group" id="range-control">
                    <div class="control-label">
                        <span>Neighborhood Range</span>
                        <span class="control-value" id="range-value">2</span>
                    </div>
                    <input type="range" id="range-slider" min="1" max="8" step="1" value="2">
                </div>
                
                <!-- Rule-specific parameters -->
                <div class="control-group" id="harmonic-control" style="display: none;">
                    <div class="control-label">
                        <span>2nd Harmonic (a‚ÇÇ)</span>
                        <span class="control-value" id="harmonic-value">0.40</span>
                    </div>
                    <input type="range" id="harmonic-slider" min="0" max="1" step="0.01" value="0.4">
                </div>

                <div class="control-group" id="harmonic3-control" style="display: none;">
                    <div class="control-label">
                        <span>3rd Harmonic (a‚ÇÉ)</span>
                        <span class="control-value" id="harmonic3-value">0.00</span>
                    </div>
                    <input type="range" id="harmonic3-slider" min="0" max="1" step="0.01" value="0.0">
                </div>

                <div class="control-group" id="delay-control" style="display: none;">
                    <div class="control-label">
                        <span>Delay Steps (œÑ)</span>
                        <span class="control-value" id="delay-value">10</span>
                    </div>
                    <input type="range" id="delay-slider" min="1" max="30" step="1" value="10">
                </div>
            </div>
            
            <!-- 4. KERNEL PARAMETERS -->
            <div class="section" id="kernel-section" style="display: none;">
                <div class="section-title">Coupling Kernel</div>
                <div style="font-size: 11px; color: #888; margin-bottom: 12px;">
                    Spatial coupling kernel shape. Positive = excitatory, Negative = inhibitory.
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <!-- Global Parameters -->
                    <div style="display: flex; flex-direction: column; gap: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                        <div style="font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Global Parameters</div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Inner œÉ (excitation)</span>
                                <span class="control-value" id="sigma-value">1.20</span>
                            </div>
                            <input type="range" id="sigma-slider" min="0.3" max="4" step="0.1" value="1.2">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Outer œÉ2 (inhibition width)</span>
                                <span class="control-value" id="sigma2-value">2.20</span>
                            </div>
                            <input type="range" id="sigma2-slider" min="0.3" max="6" step="0.1" value="2.2">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Kernel Œ≤ (inhibition)</span>
                                <span class="control-value" id="beta-value">0.60</span>
                            </div>
                            <input type="range" id="beta-slider" min="0" max="1.5" step="0.05" value="0.6">
                        </div>
                    </div>
                    
                    <!-- Primary Kernel -->
                    <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                        <div style="font-size: 10px; color: #8cf; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Primary Kernel</div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Shape</span>
                            </div>
                            <select id="kernel-shape-select">
                                <option value="0">Isotropic (circular)</option>
                                <option value="1">Anisotropic (elliptical)</option>
                                <option value="2">Multi-Scale (nested)</option>
                                <option value="3">Asymmetric (directional)</option>
                                <option value="4">Step (rectangular)</option>
                                <option value="5">Multi-Ring (concentric)</option>
                                <option value="6">Gabor (oscillatory)</option>
                            </select>
                        </div>
                    
                    <!-- Primary: Anisotropic controls -->
                    <div id="anisotropic-controls" style="display: none; flex-direction: column; gap: 16px; padding-left: 12px; border-left: 2px solid #333;">
                        <div class="control-group">
                            <div class="control-label">
                                <span>Orientation (angle)</span>
                                <span class="control-value" id="kernel-orientation-value">0¬∞</span>
                            </div>
                            <input type="range" id="kernel-orientation-slider" min="0" max="6.28318" step="0.0873" value="0">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Aspect Ratio</span>
                                <span class="control-value" id="kernel-aspect-value">1.0</span>
                            </div>
                            <input type="range" id="kernel-aspect-slider" min="1" max="5" step="0.1" value="1">
                        </div>
                    </div>
                    
                    <!-- Multi-scale controls (hidden by default) -->
                    <div id="multiscale-controls" style="display: none; flex-direction: column; gap: 16px; padding-left: 12px; border-left: 2px solid #333;">
                        <div class="control-group">
                            <div class="control-label">
                                <span>Scale 2 Weight (2√ó size)</span>
                                <span class="control-value" id="kernel-scale2-value">0.0</span>
                            </div>
                            <input type="range" id="kernel-scale2-slider" min="-0.5" max="0.5" step="0.05" value="0">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Scale 3 Weight (3√ó size)</span>
                                <span class="control-value" id="kernel-scale3-value">0.0</span>
                            </div>
                            <input type="range" id="kernel-scale3-slider" min="-0.5" max="0.5" step="0.05" value="0">
                        </div>
                    </div>
                    
                    <!-- Asymmetric controls (hidden by default) -->
                    <div id="asymmetric-controls" style="display: none; flex-direction: column; gap: 16px; padding-left: 12px; border-left: 2px solid #333;">
                        <div class="control-group">
                            <div class="control-label">
                                <span>Orientation (direction)</span>
                                <span class="control-value" id="kernel-asymmetric-orientation-value">0¬∞</span>
                            </div>
                            <input type="range" id="kernel-asymmetric-orientation-slider" min="0" max="6.28318" step="0.0873" value="0">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Asymmetry</span>
                                <span class="control-value" id="kernel-asymmetry-value">0.0</span>
                            </div>
                            <input type="range" id="kernel-asymmetry-slider" min="-1" max="1" step="0.1" value="0">
                        </div>
                    </div>
                    
                    <!-- Multi-ring controls (hidden by default) -->
                    <div id="multiring-controls" style="display: none; flex-direction: column; gap: 16px; padding-left: 12px; border-left: 2px solid #333;">
                        <div class="control-group">
                            <div class="control-label">
                                <span>Number of Rings</span>
                                <span class="control-value" id="kernel-rings-value">3</span>
                            </div>
                            <input type="range" id="kernel-rings-slider" min="1" max="5" step="1" value="3">
                        </div>
                        
                        <div style="font-size: 10px; color: #666; padding: 8px; background: rgba(255,255,0,0.05); border-radius: 4px; margin-top: 8px;">
                            üí° Tip: Each ring's outer radius should be larger than the previous ring's radius for proper nesting
                        </div>
                        
                        <!-- Individual ring controls -->
                        <div id="ring-1-controls" class="ring-control" style="display: flex; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 1 (innermost)</div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Outer radius</span>
                                    <span class="control-value" id="ring-1-width-value">0.20</span>
                                </div>
                                <input type="range" id="ring-1-width-slider" min="0.05" max="1.0" step="0.05" value="0.2">
                            </div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Weight</span>
                                    <span class="control-value" id="ring-1-weight-value">1.00</span>
                                </div>
                                <input type="range" id="ring-1-weight-slider" min="-1" max="1" step="0.1" value="1.0">
                            </div>
                        </div>
                        
                        <div id="ring-2-controls" class="ring-control" style="display: flex; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 2</div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Outer radius</span>
                                    <span class="control-value" id="ring-2-width-value">0.40</span>
                                </div>
                                <input type="range" id="ring-2-width-slider" min="0.05" max="1.0" step="0.05" value="0.4">
                            </div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Weight</span>
                                    <span class="control-value" id="ring-2-weight-value">-0.60</span>
                                </div>
                                <input type="range" id="ring-2-weight-slider" min="-1" max="1" step="0.1" value="-0.6">
                            </div>
                        </div>
                        
                        <div id="ring-3-controls" class="ring-control" style="display: flex; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 3</div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Outer radius</span>
                                    <span class="control-value" id="ring-3-width-value">0.60</span>
                                </div>
                                <input type="range" id="ring-3-width-slider" min="0.05" max="1.0" step="0.05" value="0.6">
                            </div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Weight</span>
                                    <span class="control-value" id="ring-3-weight-value">0.80</span>
                                </div>
                                <input type="range" id="ring-3-weight-slider" min="-1" max="1" step="0.1" value="0.8">
                            </div>
                        </div>
                        
                        <div id="ring-4-controls" class="ring-control" style="display: none; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 4</div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Outer radius</span>
                                    <span class="control-value" id="ring-4-width-value">0.80</span>
                                </div>
                                <input type="range" id="ring-4-width-slider" min="0.05" max="1.0" step="0.05" value="0.8">
                            </div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Weight</span>
                                    <span class="control-value" id="ring-4-weight-value">-0.40</span>
                                </div>
                                <input type="range" id="ring-4-weight-slider" min="-1" max="1" step="0.1" value="-0.4">
                            </div>
                        </div>
                        
                        <div id="ring-5-controls" class="ring-control" style="display: none; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 5 (outermost)</div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Outer radius</span>
                                    <span class="control-value" id="ring-5-width-value">1.00</span>
                                </div>
                                <input type="range" id="ring-5-width-slider" min="0.05" max="1.0" step="0.05" value="1.0">
                            </div>
                            <div class="control-group" style="margin: 0;">
                                <div class="control-label">
                                    <span style="font-size: 11px;">Weight</span>
                                    <span class="control-value" id="ring-5-weight-value">0.50</span>
                                </div>
                                <input type="range" id="ring-5-weight-slider" min="-1" max="1" step="0.1" value="0.5">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gabor controls (hidden by default) -->
                    <div id="gabor-controls" style="display: none; flex-direction: column; gap: 16px; padding-left: 12px; border-left: 2px solid #333;">
                        <div style="font-size: 10px; color: #888; padding: 8px; background: rgba(255,200,100,0.05); border-radius: 4px;">
                            üåä Gabor kernels create oriented, wavelike patterns ‚Äî like visual cortex receptive fields. Adjust spatial frequency magnitude and direction.
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Spatial Frequency (k)</span>
                                <span class="control-value" id="kernel-spatial-freq-value">2.0</span>
                            </div>
                            <input type="range" id="kernel-spatial-freq-slider" min="0.5" max="8" step="0.1" value="2.0">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Frequency Direction (Œ∏)</span>
                                <span class="control-value" id="kernel-freq-angle-value">0¬∞</span>
                            </div>
                            <input type="range" id="kernel-freq-angle-slider" min="0" max="6.28318" step="0.0873" value="0">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Phase Offset (œÜ)</span>
                                <span class="control-value" id="kernel-gabor-phase-value">0¬∞</span>
                            </div>
                            <input type="range" id="kernel-gabor-phase-slider" min="0" max="6.28318" step="0.0873" value="0">
                        </div>
                    </div>
                    </div>
                    
                    <!-- Secondary Kernel -->
                    <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(100,200,255,0.03); border-radius: 4px; border: 1px solid rgba(100,200,255,0.2);">
                        <div style="font-size: 10px; color: #8cf; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Secondary Kernel (Optional)</div>
                        
                        <div class="control-group">
                            <div class="control-label">
                                <span>Shape</span>
                            </div>
                            <select id="kernel-secondary-dropdown" style="padding: 4px 8px; background: #1a1a1a; color: #eee; border: 1px solid #444; border-radius: 4px; font-size: 11px;">
                                <option value="-1">None</option>
                                <option value="0">Isotropic</option>
                                <option value="1">Anisotropic</option>
                                <option value="2">Multi-scale</option>
                                <option value="3">Asymmetric</option>
                                <option value="4">Step</option>
                                <option value="5">Multi-ring</option>
                                <option value="6">Gabor</option>
                            </select>
                        </div>
                        
                        <!-- Secondary kernel parameters (shown when secondary != None) -->
                        <div id="secondary-kernel-params" style="display: none; flex-direction: column; gap: 12px;">
                            
                            <!-- Secondary: Anisotropic controls -->
                            <div id="secondary-anisotropic-controls" style="display: none; flex-direction: column; gap: 12px;">
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Orientation (angle)</span>
                                        <span class="control-value" id="secondary-kernel-orientation-value">0¬∞</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-orientation-slider" min="0" max="6.28318" step="0.0873" value="0">
                                </div>
                                
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Aspect Ratio</span>
                                        <span class="control-value" id="secondary-kernel-aspect-value">1.0</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-aspect-slider" min="1" max="5" step="0.1" value="1">
                                </div>
                            </div>
                            
                            <!-- Secondary: Multi-scale controls -->
                            <div id="secondary-multiscale-controls" style="display: none; flex-direction: column; gap: 12px;">
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Scale 2 Weight (2√ó size)</span>
                                        <span class="control-value" id="secondary-kernel-scale2-value">0.0</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-scale2-slider" min="-0.5" max="0.5" step="0.05" value="0">
                                </div>
                                
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Scale 3 Weight (3√ó size)</span>
                                        <span class="control-value" id="secondary-kernel-scale3-value">0.0</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-scale3-slider" min="-0.5" max="0.5" step="0.05" value="0">
                                </div>
                            </div>
                            
                            <!-- Secondary: Asymmetric controls -->
                            <div id="secondary-asymmetric-controls" style="display: none; flex-direction: column; gap: 12px;">
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Orientation (direction)</span>
                                        <span class="control-value" id="secondary-kernel-asymmetric-orientation-value">0¬∞</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-asymmetric-orientation-slider" min="0" max="6.28318" step="0.0873" value="0">
                                </div>
                                
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Asymmetry</span>
                                        <span class="control-value" id="secondary-kernel-asymmetry-value">0.0</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-asymmetry-slider" min="-1" max="1" step="0.1" value="0">
                                </div>
                            </div>
                            
                            <!-- Secondary: Multi-ring controls -->
                            <div id="secondary-multiring-controls" style="display: none; flex-direction: column; gap: 12px;">
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Number of Rings</span>
                                        <span class="control-value" id="secondary-kernel-rings-value">2</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-rings-slider" min="1" max="5" step="1" value="2">
                                </div>
                                
                                <!-- Ring 1 -->
                                <div id="secondary-ring-1-controls" style="display: flex; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; margin-top: 8px;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 1 (center)</div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Outer radius</span>
                                            <span class="control-value" id="secondary-kernel-ring1-width-value">0.20</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring1-width-slider" min="0.05" max="1" step="0.05" value="0.2">
                                    </div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Weight</span>
                                            <span class="control-value" id="secondary-kernel-ring1-weight-value">1.00</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring1-weight-slider" min="-1" max="1" step="0.05" value="1">
                                    </div>
                                </div>
                                
                                <!-- Ring 2 -->
                                <div id="secondary-ring-2-controls" style="display: flex; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; margin-top: 8px;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 2</div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Outer radius</span>
                                            <span class="control-value" id="secondary-kernel-ring2-width-value">0.40</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring2-width-slider" min="0.05" max="1" step="0.05" value="0.4">
                                    </div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Weight</span>
                                            <span class="control-value" id="secondary-kernel-ring2-weight-value">-0.50</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring2-weight-slider" min="-1" max="1" step="0.05" value="-0.5">
                                    </div>
                                </div>
                                
                                <!-- Ring 3 -->
                                <div id="secondary-ring-3-controls" style="display: none; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; margin-top: 8px;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 3</div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Outer radius</span>
                                            <span class="control-value" id="secondary-kernel-ring3-width-value">0.60</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring3-width-slider" min="0.05" max="1" step="0.05" value="0.6">
                                    </div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Weight</span>
                                            <span class="control-value" id="secondary-kernel-ring3-weight-value">0.00</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring3-weight-slider" min="-1" max="1" step="0.05" value="0">
                                    </div>
                                </div>
                                
                                <!-- Ring 4 -->
                                <div id="secondary-ring-4-controls" style="display: none; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; margin-top: 8px;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 4</div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Outer radius</span>
                                            <span class="control-value" id="secondary-kernel-ring4-width-value">0.80</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring4-width-slider" min="0.05" max="1" step="0.05" value="0.8">
                                    </div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Weight</span>
                                            <span class="control-value" id="secondary-kernel-ring4-weight-value">0.00</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring4-weight-slider" min="-1" max="1" step="0.05" value="0">
                                    </div>
                                </div>
                                
                                <!-- Ring 5 -->
                                <div id="secondary-ring-5-controls" style="display: none; flex-direction: column; gap: 8px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; margin-top: 8px;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">Ring 5 (outermost)</div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Outer radius</span>
                                            <span class="control-value" id="secondary-kernel-ring5-width-value">1.00</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring5-width-slider" min="0.05" max="1" step="0.05" value="1">
                                    </div>
                                    <div class="control-group" style="margin: 0;">
                                        <div class="control-label">
                                            <span style="font-size: 11px;">Weight</span>
                                            <span class="control-value" id="secondary-kernel-ring5-weight-value">0.00</span>
                                        </div>
                                        <input type="range" id="secondary-kernel-ring5-weight-slider" min="-1" max="1" step="0.05" value="0">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Secondary: Gabor controls -->
                            <div id="secondary-gabor-controls" style="display: none; flex-direction: column; gap: 12px;">
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Spatial Frequency (k)</span>
                                        <span class="control-value" id="secondary-kernel-spatial-freq-value">2.0</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-spatial-freq-slider" min="0.5" max="8" step="0.1" value="2.0">
                                </div>
                                
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Frequency Direction (Œ∏)</span>
                                        <span class="control-value" id="secondary-kernel-freq-angle-value">0¬∞</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-freq-angle-slider" min="0" max="6.28318" step="0.0873" value="0">
                                </div>
                                
                                <div class="control-group">
                                    <div class="control-label">
                                        <span>Phase Offset (œÜ)</span>
                                        <span class="control-value" id="secondary-kernel-gabor-phase-value">0¬∞</span>
                                    </div>
                                    <input type="range" id="secondary-kernel-gabor-phase-slider" min="0" max="6.28318" step="0.0873" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mix Ratio (outside secondary kernel box, only shows when composition enabled) -->
                    <div id="kernel-mix-ratio-container" style="display: none;">
                        <div class="control-group">
                            <div class="control-label">
                                <span>Mix Ratio</span>
                                <span class="control-value" id="kernel-mix-ratio-value">0.50</span>
                            </div>
                            <input type="range" id="kernel-mix-ratio-slider" min="0" max="1" step="0.05" value="0.5">
                            <div style="font-size: 9px; color: #666; margin-top: 2px;">
                                0.0 = all secondary | 0.5 = equal blend | 1.0 = all primary
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 5. INTEGRATION -->
            <div class="section">
                <div class="section-title">Integration & Noise</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Time Step (dt)</span>
                        <span class="control-value" id="dt-value">0.03</span>
                    </div>
                    <input type="range" id="dt-slider" min="0.001" max="0.1" step="0.001" value="0.03">
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Time Scale</span>
                        <span class="control-value" id="time-scale-display">1.0√ó</span>
                    </div>
                    <div class="button-group">
                        <button id="slow-btn">0.5√ó Slower</button>
                        <button id="fast-btn">2√ó Faster</button>
                        <button id="normal-btn">Reset 1√ó</button>
                        <button id="pause-btn">Pause</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Noise Strength</span>
                        <span class="control-value" id="noise-value">0.00</span>
                    </div>
                    <input type="range" id="noise-slider" min="0" max="0.5" step="0.01" value="0.0">
                </div>
            </div>
            
            <!-- 6. VISUALIZATION -->
            <div class="section">
                <div class="section-title">Visualization</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Color Mode</span>
                    </div>
                    <select id="colormap-select">
                        <option value="0">Phase (rainbow)</option>
                        <option value="1">Velocity (dŒ∏/dt)</option>
                        <option value="2">Curvature (‚àá¬≤Œ∏)</option>
                        <option value="3">Order Parameter</option>
                        <option value="4">Image Texture</option>
                        <option value="5">Viridis</option>
                        <option value="6">Plasma</option>
                        <option value="7">Twilight (cyclic)</option>
                        <option value="8">Inferno</option>
                        <option value="9">Chirality (spirals)</option>
                        <option value="10">Phase + Gradient</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="bilinear-interp" style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Smooth Interpolation (2D)</span>
                    </label>
                </div>
            </div>
            
            <!-- KEYBOARD SHORTCUTS -->
            <div class="keyboard-hint">
                <strong>Keyboard Shortcuts</strong><br>
                <kbd>0</kbd>-<kbd>5</kbd> Switch rules<br>
                <kbd>R</kbd> Reset state<br>
                <kbd>G</kbd> Toggle global coupling<br>
                <kbd>C</kbd> Cycle colormaps<br>
                <kbd>V</kbd> Toggle 2D/3D view<br>
                <kbd>Space</kbd> Pause/Resume<br>
                <kbd>[</kbd><kbd>]</kbd> Adjust speed<br>
                <kbd>‚Üë</kbd><kbd>‚Üì</kbd> Adjust coupling<br>
                <kbd>‚Üê</kbd><kbd>‚Üí</kbd> Adjust range<br>
                <kbd>Shift</kbd>+<kbd>‚Üë</kbd><kbd>‚Üì</kbd> Adjust grid size<br>
                <kbd>+</kbd><kbd>-</kbd> Zoom in/out (2D)<br>
                <kbd>Z</kbd> Reset zoom (2D)<br>
                <br>
                <strong>Mouse (2D Mode)</strong><br>
                Drag to pan<br>
                Scroll to zoom<br>
                Double-click to reset view
            </div>
        </div>
        
        <!-- VISUALIZER PANEL (Third Column) -->
        <div id="visualizer-panel">
            <div class="viz-section">
                <div class="viz-title">1D Kernel Profile</div>
                <canvas id="kernel-canvas-1d" width="280" height="120" style="width: 100%; height: 120px; border-radius: 4px;"></canvas>
            </div>
            
            <div class="viz-section">
                <div class="viz-title">2D Kernel (Top View)</div>
                <canvas id="kernel-canvas-2d" width="280" height="280" style="width: 100%; height: 280px; border-radius: 4px;"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // Make all sections collapsible
        function toggleSection(titleEl) {
            titleEl.classList.toggle('collapsed');
            const content = titleEl.nextElementSibling;
            if (content && content.classList.contains('section-content')) {
                content.classList.toggle('collapsed');
            }
        }
        
        // Initialize all sections as collapsible
        document.addEventListener('DOMContentLoaded', () => {
            const titles = document.querySelectorAll('.section-title');
            titles.forEach(title => {
                if (!title.onclick) {
                    title.onclick = () => toggleSection(title);
                }
                // Wrap content if not already wrapped
                let next = title.nextElementSibling;
                if (next && !next.classList.contains('section-content')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'section-content';
                    title.parentNode.insertBefore(wrapper, next);
                    while (next && !next.classList.contains('section-title') && !next.classList.contains('section-content')) {
                        const current = next;
                        next = next.nextElementSibling;
                        wrapper.appendChild(current);
                    }
                }
            });
        });
    </script>
    
    <script type="module" src="./src/main.js"></script>
</body>
</html>
